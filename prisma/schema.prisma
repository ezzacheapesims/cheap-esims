generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AdminLog {
  id         String   @id
  action     String
  adminEmail String
  entityType String
  entityId   String
  data       Json
  createdAt  DateTime @default(now())
}

model AdminSettings {
  id                   String   @id @default("settings")
  mockMode             Boolean  @default(false)
  defaultMarkupPercent Float    @default(0)
  defaultCurrency      String   @default("USD")
  adminEmails          String[]
  createdAt            DateTime @default(now())
  updatedAt            DateTime
  emailEnabled         Boolean  @default(true)
  emailFrom            String?
  emailProvider        String?
  discountsJson        Json?
  pricingJson           Json?
}

model Affiliate {
  id                        String                      @id
  userId                    String                      @unique
  referralCode              String                      @unique
  totalCommission           Int                         @default(0)
  createdAt                 DateTime                    @default(now())
  isFrozen                  Boolean                     @default(false)
  User                      User                        @relation(fields: [userId], references: [id])
  AffiliateClick            AffiliateClick[]
  AffiliateCommissionPayout AffiliateCommissionPayout[]
  AffiliateFraudEvent       AffiliateFraudEvent[]
  AffiliateFraudScore       AffiliateFraudScore?
  AffiliatePayoutMethod     AffiliatePayoutMethod?
  AffiliatePayoutRequest    AffiliatePayoutRequest[]
  AffiliateSignup           AffiliateSignup[]
  Commission                Commission[]
  Referral                  Referral[]

  @@index([referralCode])
}

model AffiliateClick {
  id                String    @id
  affiliateId       String
  referralCode      String
  ipAddress         String?
  userAgent         String?
  device            String?
  browser           String?
  country           String?
  deviceFingerprint String?
  createdAt         DateTime  @default(now())
  Affiliate         Affiliate @relation(fields: [affiliateId], references: [id])

  @@index([affiliateId])
  @@index([createdAt])
  @@index([deviceFingerprint])
  @@index([ipAddress])
  @@index([referralCode])
}

model AffiliateCommissionPayout {
  id          String    @id
  affiliateId String
  type        String
  amountCents Int
  createdAt   DateTime  @default(now())
  Affiliate   Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@index([affiliateId, createdAt])
  @@index([affiliateId])
}

model AffiliateFraudEvent {
  id          String    @id
  affiliateId String
  userId      String?
  relatedId   String?
  type        String
  score       Int
  metadata    Json?
  createdAt   DateTime  @default(now())
  Affiliate   Affiliate @relation(fields: [affiliateId], references: [id])

  @@index([affiliateId])
  @@index([createdAt])
  @@index([type])
}

model AffiliateFraudScore {
  affiliateId String    @id
  totalScore  Int       @default(0)
  riskLevel   String    @default("low")
  updatedAt   DateTime
  Affiliate   Affiliate @relation(fields: [affiliateId], references: [id])
}

model AffiliatePayoutMethod {
  id             String    @id
  affiliateId    String    @unique
  type           String
  paypalEmail    String?
  bankHolderName String?
  bankIban       String?
  bankSwift      String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime
  Affiliate      Affiliate @relation(fields: [affiliateId], references: [userId], onDelete: Cascade)

  @@index([affiliateId])
}

model AffiliatePayoutRequest {
  id          String    @id
  affiliateId String
  amountCents Int
  status      String
  adminNote   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  processedAt DateTime?
  Affiliate   Affiliate @relation(fields: [affiliateId], references: [userId], onDelete: Cascade)

  @@index([affiliateId])
  @@index([affiliateId, status])
  @@index([createdAt])
  @@index([status])
}

model AffiliateSignup {
  id                String    @id
  affiliateId       String
  referralCode      String
  userId            String    @unique
  ipAddress         String?
  userAgent         String?
  device            String?
  browser           String?
  country           String?
  deviceFingerprint String?
  createdAt         DateTime  @default(now())
  Affiliate         Affiliate @relation(fields: [affiliateId], references: [id])
  User              User      @relation(fields: [userId], references: [id])

  @@index([affiliateId])
  @@index([createdAt])
  @@index([deviceFingerprint])
  @@index([referralCode])
}

model Commission {
  id          String    @id
  affiliateId String
  orderId     String?
  orderType   String
  amountCents Int
  createdAt   DateTime  @default(now())
  availableAt DateTime?
  status      String    @default("pending")
  Affiliate   Affiliate @relation(fields: [affiliateId], references: [id])

  @@index([affiliateId])
  @@index([affiliateId, status])
  @@index([orderId])
  @@index([status])
}

model DeviceSupport {
  id           String   @id
  manufacturer String
  model        String
  supported    Boolean  @default(false)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime

  @@index([manufacturer])
  @@index([manufacturer, model])
  @@index([model])
}

model EmailLog {
  id         String   @id
  to         String
  from       String
  subject    String
  template   String
  variables  Json?
  providerId String?
  status     String
  error      String?
  createdAt  DateTime @default(now())
}

model ErrorLog {
  id        String   @id
  message   String
  stack     String?
  route     String
  userId    String?
  status    Int?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([route])
  @@index([userId])
}

model EsimProfile {
  id               String             @id
  orderId          String
  esimTranNo       String
  iccid            String             @unique
  qrCodeUrl        String?
  ac               String?
  smdpStatus       String?
  esimStatus       String?
  totalVolume      BigInt?
  orderUsage       BigInt?
  expiredTime      DateTime?
  userId           String?
  Order            Order              @relation(fields: [orderId], references: [id])
  User             User?              @relation(fields: [userId], references: [id])
  EsimUsageHistory EsimUsageHistory[]
  TopUp            TopUp[]

  @@index([orderId])
  @@index([userId])
}

model EsimUsageHistory {
  id          String      @id
  profileId   String
  usedBytes   BigInt
  recordedAt  DateTime    @default(now())
  EsimProfile EsimProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([profileId, recordedAt])
}

model MobileToken {
  id        String   @id
  userId    String
  token     String   @unique @db.VarChar(255)
  createdAt DateTime @default(now())
  expiresAt DateTime
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([token])
  @@index([userId])
}

model Order {
  id                 String        @id
  userId             String
  planId             String
  amountCents        Int
  currency           String
  status             String
  paymentMethod      String
  paymentRef         String?       @unique
  esimOrderNo        String?
  createdAt          DateTime      @default(now())
  receiptSent        Boolean       @default(false)
  displayAmountCents Int?
  displayCurrency    String?
  refundAmountCents  Int?
  refundMethod       String?
  refundedAt         DateTime?
  duration           Int?          // Selected duration for Unlimited/Day Pass plans
  EsimProfile        EsimProfile[]
  User               User          @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([paymentRef])
  @@index([status])
  @@index([userId])
}

model Plan {
  id           String   @id
  providerId   String
  locationCode String
  name         String
  dataBytes    BigInt
  validityDays Int
  priceCents   Int
  currency     String
  externalSlug String
  createdAt    DateTime @default(now())
}

model RateLimitLog {
  id        String   @id
  ip        String
  userId    String?
  route     String
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([ip])
  @@index([route])
  @@index([userId])
}

model Referral {
  id             String    @id
  affiliateId    String
  referredUserId String    @unique
  createdAt      DateTime  @default(now())
  Affiliate      Affiliate @relation(fields: [affiliateId], references: [id])
  User           User      @relation(fields: [referredUserId], references: [id])

  @@index([affiliateId])
  @@index([referredUserId])
}

model SecurityEventLog {
  id        String   @id
  type      String
  ip        String?
  userId    String?
  details   Json?
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([ip])
  @@index([type])
  @@index([userId])
}

model SupportTicket {
  id        String              @id
  name      String
  email     String
  userId    String?             // Link to user account if authenticated
  orderId   String?
  device    String?
  message   String              @db.VarChar(1000)
  createdAt DateTime            @default(now())
  SupportTicketReply SupportTicketReply[]

  @@index([createdAt])
  @@index([email])
  @@index([orderId])
  @@index([userId])
}

model SupportTicketReply {
  id           String        @id
  ticketId     String
  message      String        @db.VarChar(2000)
  isAdmin      Boolean       @default(false) // true if admin reply, false if customer reply
  adminEmail   String?       // Admin email if this is an admin reply
  createdAt    DateTime      @default(now())
  SupportTicket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([createdAt])
}

model TopUp {
  id                 String      @id
  userId             String
  profileId          String
  planCode           String
  amountCents        Int
  currency           String
  status             String
  paymentRef         String?
  rechargeOrder      String?
  createdAt          DateTime    @default(now())
  displayCurrency    String?
  displayAmountCents Int?
  EsimProfile        EsimProfile @relation(fields: [profileId], references: [id])
  User               User        @relation(fields: [userId], references: [id])
}

model User {
  id               String             @id
  email            String             @unique
  name             String?
  createdAt        DateTime           @default(now())
  Affiliate        Affiliate?
  AffiliateSignup  AffiliateSignup?
  EsimProfile      EsimProfile[]
  MobileToken      MobileToken[]
  Order            Order[]
  Referral         Referral?
  TopUp            TopUp[]
  SpareChangeBalance     SpareChangeBalance?
  SpareChangeTransaction SpareChangeTransaction[]
  Review           Review[]
}

model SpareChangeBalance {
  userId       String   @id
  balanceCents Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("VCashBalance")
}

model SpareChangeTransaction {
  id          String   @id
  userId      String
  type        String
  amountCents Int
  reason      String
  metadata    Json?
  createdAt   DateTime @default(now())
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([userId, createdAt])
  @@index([userId])
  @@map("VCashTransaction")
}

model Review {
  id        String   @id
  planId    String
  userId    String
  userName  String
  rating    Int      // 1-5
  comment   String   @db.VarChar(1000)
  verified  Boolean  @default(false) // true if user has purchased this plan
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@index([userId])
  @@index([createdAt])
}

model WebhookEvent {
  id        String   @id
  source    String
  payload   Json
  processed Boolean  @default(false)
  createdAt DateTime @default(now())
}
